<!DOCTYPE html>

<html>

<head>
    <title>view</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script>
        //예시
        var post;
        $(document).ready(function () {

            var latitude = 127.0078127;
            var longtitude = 37.592483099999995;
            //현재 위치에 맞는 포스팅 불러오기
            console.log("click " + latitude + longtitude);
            $.post('/showpost', { lat: latitude, lng: longtitude },
                function (data, status) {
                    post = data;
                }
            )

            $('#markerid').click(function () {
                display(post);
            })

            function display(post) {
                alert("내용 보여주기");
                console.log("총 내보낼 포스트의 길이는 " + post.length);

                var html = "";
                var url1 = "http://localhost:3000/uploads/";

                for (var i = 0; i < post.length; i++) {
                    console.log("포스트 하나 추가");
                    var imgs = '';
                    var middle;
                    for (var j = 0; j < post[i].filenumber; j++) {
                        var img = url1 + post[i][`image${j}`];
                        console.log(img);
                        imgs += `<img src="${img}" width="40%">`;
                    }
                    // alert(imgs);

                    middle = `<article>
                    <header id="header" style="border: 5px solid black;"> 
                     <div id="title"> ${post[i].location} </div> <div id="작성자"> ${post[i].writer}</div>
                    </header>
                    <div id="posting_photo" style="border: 5px solid black;">
                        <section id="imgs${i}">` + imgs + `</section>
                    </div>
                    <div id="posting_add" style="border: 5px solid black;">
                        <button type="button" onclick="likes(${i})"> 좋아요 </button> <span id="likes${i}">${post[i].likes}</span>
                        <button type="button" onclick="shows(${i})"> 댓글보기 및 달기 </button>
                    </div>
                    <div id="information" style="border: 5px solid black;">
                        <div class="time">${post[i].time}</div>
                        <div class="category">${post[i].category}</div>
                    </div>
                    <div id="posting_comment" style="border: 5px solid black;">
                        <div id="comment">${post[i].posting_content}</div>
                    </div>
                    <div id="show_comment${i}" style="border: 5px solid black;"></div>
                    <div id="add_comment${i}" style="border: 5px solid black;"></div>
                    </article> <hr>`;

                    html += middle;
                    console.log(middle);
                }
                document.getElementById("new").innerHTML = html;
            }
        })

        let html1 = "";
        function shows(num) {
            console.log("show comment button click");
            var showc = document.getElementById(`show_comment${num}`);
            var addc = document.getElementById(`add_comment${num}`);
            var open = document.getElementById(`num${i}`).value;
            let length = post[num].comments.length;

            if ((open % 2) == 1) {
                if (length > 0) {
                    let exist1 = "";
                    for (var i = 0; i < length; i++) {
                        console.log('댓글 ' + i)
                        //let euser = post[num].comments[i].writer;
                        let etime = post[num].comments[i].time;
                        let ecomment = post[num].comments[i].content;
                        //사이에 ${euser}넣기
                        exist1 += `<div id="euser"></div> 
                                <div id="etime">${etime}</div> 
                                <div id="ecomment">${ecomment}</div>`
                        html1 += exist1;
                    }
                    document.getElementById(`show_comment${num}`).innerHTML = html1;
                } //댓글창 보이기 var
                let exist2 = "";
                exist2 = `<textarea class="add" col="50" row="30" placeholder = "댓글을 입력해주세요" >
                    </textarea ><button class="done" onclick="add(${num})">comment</button>`
                addc.innerHTML = exist2;

            } else {
                console.log("댓글 확인 창 닫습니다.");
                while (showc.firstChild) {
                    showc.removeChild(showc.firstChild);
                }
                while (addc.firstChild) {
                    addc.removeChild(addc.firstChild);
                }
            }
            open++;
        }

        function add(num) {
            console.log("댓글 저장");
            if ($("textarea").val().trim() == "") {
                alert("내용을 입력하세요.");
                $("textarea").focus();
                return false;
            }

            let comment = document.getElementById('add').value;
            console.log(comment);
            let time = new Date().toLocaleString();
            console.log(time);
            //let writer = userInfo.name.toString();

            //사이에 ${writer}넣기
            html1 += `<div id="euser"></div> 
                        <div id="etime">${time}</div> 
                        <div id="ecomment">${comment}</div>`
            document.getElementById(`show_comment${num}`).innerHTML = html1;

            // //몽고디비에 추가하기 
            // console.log("지금부터 db에 댓글 추가");
            // $.post(url + '/addcomment', { post_id: post[num]._id, post_name: writer, post_time: time, post_comment: comment },
            //     function (data, status) {
            //         console.log("db에 전송완료" + data);
            //     }
            // )
        }

        var liked = true;
        function likes(num) {
            console.log(num);
            var likess = post[num].likes;
            if (liked === true) {
                likess++;
                $.post('/likes', { post_id: post[num]._id, likes: likess },
                    function (data, status) {
                        console.log(data);
                    });
                document.getElementById(`likes${num}`).innerHTML = `<span id="likes"> ${likess} </span>`;
                liked = false;
            } else {
                $.post('/likes', { post_id: post[num]._id, likes: likess },
                    function (data, status) {
                        console.log("좋아요 제거");
                    });
                document.getElementById(`likes${num}`).innerHTML = `<span id="likes"> ${likess} </span>`;
                liked = true;
            }
        }
    </script>
</head>

<body>
    <button type="button" id="markerid" data-bs-toggle="modal" data-bs-target="#staticBackdrop2">
        마커누름
    </button>

    <div class="modal fade" id="staticBackdrop2" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-sm-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">리뷰보기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="new">
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

</html>