<!DOCTYPE html>

<html>

<head>
    <title>view</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script>
        //예시
        var post;
        var open = true;
        $(document).ready(function () {

            var latitude = 127.0078127;
            var longtitude = 37.592483099999995;
            alert("현재위치");
            //현재 위치에 맞는 포스팅 불러오기
            console.log("click " + latitude + longtitude);
            $.post('/showpost', { lat: latitude, lng: longtitude },
                function (data, status) {
                    post = data;
                    alert("현재위치확인 " + post);
                }
            )

            $('#markerid').click(function () {
                alert('모달창 실행')
                display(post);
            })

            function display(post) {
                alert("내용 보여주기");
                console.log("총 내보낼 포스트의 길이는 " + post.length);

                var html = "";
                var url1 = "http://localhost:3000/uploads/";

                for (var i = 0; i < post.length; i++) {
                    console.log("포스트 하나 추가");
                    var imgs = '';
                    var middle;
                    for (var j = 0; j < post[i].filenumber; j++) {
                        var img = url1 + post[i][`image${j}`];
                        console.log(img);
                        imgs += `<img src="${img}" width="40%">`;
                    }
                    // alert(imgs);

                    middle = `<article>
                    <input id="num" value="${i}" style="display:none"></input>
                    <header id="header" style="border: 5px solid black;"> 
                     <div id="제목"> ${post[i].location} </div> <div id="작성자"> ${post[i].writer}</div>
                    </header>
                    <div id="posting_photo" style="border: 5px solid black;">
                        <section id="imgs${i}">` + imgs + `</section>
                    </div>
                    <div id="posting_add" style="border: 5px solid black;">
                        <button type="button" onclick="likes()"> 좋아요 </button> <span id="likes">${post[i].likes}</span>
                        <button type="button" onclick="show()"> 댓글보기 및 달기 </button>
                    </div>
                    <div id="information" style="border: 5px solid black;">
                        <div id="time">${post[i].time}</div>
                        <div id="category">${post[i].category}</div>
                    </div>
                    <div id="posting_comment" style="border: 5px solid black;">
                        <div id="comment">${post[i].posting_content}</div>
                    </div>
                    <div id="show_comment" style="border: 5px solid black;"></div>
                    <div id="add_comment" style="border: 5px solid black;"></div>
                    </article> <hr>`;

                    html += middle;
                    console.log(middle);
                }
                document.getElementById("new").innerHTML = html;
            }
            /////////////댓글 보여주기

            //     function show() {
            //         console.log("show comment button click");
            //         var show_comment = document.querySelector('#show_comment');
            //         var add_comment = document.querySelector('#add_comment');
            //         var num = document.getElementById("num").value;

            //         if (open === true) {
            //             for (var i = 0; i < post.add_comments.length; i++) {
            //                 console.log("이전 댓글 화면 구성중 ");
            //                 var div1 = document.createElement('div');
            //                 var div2 = document.createElement('div');
            //                 var div_user = document.createElement('div');
            //                 var div_time = document.createElement('div');
            //                 var div_comment = document.createElement('div');

            //                 div_user.setAttribute("id", 'dv_name');
            //                 //div_user.innerHTML = post[i].comments["writer"];
            //                 div_time.setAttribute("id", 'time');
            //                 //div_time.innerHTML = //이 댓글 작성 시간
            //                 div_comment.setAttribute("id", 'comment');
            //                 //div_comment.innerHTML = //이 댓글 내용;
            //                 div1.appendChild(div_user);
            //                 div1.appendChild(div_time);
            //                 div2.appendChild(div_comment);

            //                 show_comment.appendChild(div1);
            //                 show_comment.appendChild(div2);
            //             }

            //             //댓글창 보이기
            //             var add_text = document.createElement('textarea');
            //             var done = document.createElement('button');
            //             add_text.setAttribute("id", "add");
            //             add_text.setAttribute("col", "50");
            //             add_text.setAttribute("row", "30");
            //             add_text.setAttribute("placeholder", "댓글을 남겨주세요")
            //             done.setAttribute("type", "button");
            //             done.setAttribute("id", "done");
            //             done.innerHTML = "comment";

            //             add_comment.appendChild(add_text);
            //             add_comment.appendChild(done);

            //             $('#done').click(function () {
            //                 console.log("댓글확인창 열기");
            //                 if ($("textarea").val().trim() == "") {
            //                     alert("내용을 입력하세요.");
            //                     $("textarea").focus();
            //                     return false;
            //                 }

            //                 console.log("clicks");
            //                 var comment = $('#add').text();
            //                 console.log(comment);
            //                 var time = new Date().toLocaleDateString();
            //                 console.log(time);
            //                 var userid = userInfo.name.toString();

            //                 var div_user = document.createElement('div');
            //                 var div_time = document.createElement('div');
            //                 var div_comment = document.createElement('div');

            //                 div_user.setAttribute("id", 'dv_name');
            //                 //userid 고치기
            //                 div_user.innerHTML = userid;
            //                 div_time.setAttribute("id", 'time');
            //                 div_time.innerHTML = time;
            //                 div_comment.setAttribute("id", 'comment');
            //                 div_comment.innerHTML = comment;
            //                 div1.appendChild(div_user);
            //                 div1.appendChild(div_time);
            //                 div2.appendChild(div_comment);

            //                 show_comment.appendChild(div1);
            //                 show_comment.appendChild(div2);

            //                 //몽고디비에 추가하기
            //                 console.log("지금부터 db에 댓글 추가");
            //                 $.post(url + '/addcomment', { post_id: post[num]._id, post_name: userid, post_time: time, post_comment: comment },
            //                     function (data, status) {
            //                         console.log("db에 전송완료" + data);
            //                     })

            //                 open = false;
            //             })
            //         } else {
            //             console.log("댓글 확인 창 닫습니다.");
            //             while (show_comment.firstChild) {
            //                 show_comment.removeChild(show_comment.firstChild);
            //             }
            //             while (add_comment.firstChild) {
            //                 add_comment.removeChild(add_comment.firstChild);
            //             }
            //             open = true;
            //         }
            //     }

        })
        var liked = true;
        function likes() {
            var num = document.getElementById("num").value;
            alert(num);
            var likess = post[num].likes;
            alert(post[num].likes);
            if (liked === true) {
                likess++;
                $.post(url + '/likes', { post_id: post[num]._id, likes: likess },
                    function (data, status) {
                        console.log("좋아요 추가");
                    });
                $("#likes").text(likess);
                liked = false;
            } else {
                likess--;
                $.post(url + '/likes', { post_id: post[num]._id, likes: likess },
                    function (data, status) {
                        console.log("좋아요 제거");
                    });
                $("#likes").text(likess);
            }
            liked = true;
        }
    </script>
</head>

<body>
    <button type="button" id="markerid" data-bs-toggle="modal" data-bs-target="#staticBackdrop2">
        마커누름
    </button>

    <div class="modal fade" id="staticBackdrop2" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-sm-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">리뷰보기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="new">
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

</html>