<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="google-signin-client_id"
		content="358885579377-963gkpo3jr9s54a8qp28emppjsb7qqj1.apps.googleusercontent.com">

	<title>simpleMap</title>

	<!-- Bootstrap 관련 -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
		crossorigin="anonymous"></script>

	<!-- 구글 소셜 로그인 -->
	<script src="https://apis.google.com/js/platform.js" async defer></script>
	<script src="login.js"></script>

	<!-- jquery사용 -->
	<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

	<!--Tmap API : 사용하려면 주석 지우기!!-->
	<!-- <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=l7xxdb5dae09f39444cb9c87fd5289236e24"></script> -->
	<link rel="stylesheet" href="main.css">
	<script src="index.js"></script>
	<script src="login.js"></script>
	<script src="category.js"></script>
	<script>
		var latitude;
		var longtitude;

		$(document).ready(function () {

			if ("geolocation" in navigator) {	/* geolocation 사용 가능 */
				navigator.geolocation.getCurrentPosition(function (data) {

					latitude = data.coords.latitude;
					longitude = data.coords.longitude;

					reverseGeo(longitude, latitude);
					setLocation(longitude, latitude);

				}, function (error) {
					alert(error);
				});
			} else {	/* geolocation 사용 불가능 */
				alert('geolocation 사용 불가능');
			}
		});

		function reverseGeo(lon, lat) {
			$
				.ajax({
					method: "GET",
					url: "https://apis.openapi.sk.com/tmap/geo/reversegeocoding?version=1&format=json&callback=result",
					async: false,
					data: {
						"appKey": "l7xxdb5dae09f39444cb9c87fd5289236e24",
						"coordType": "WGS84GEO",
						"addressType": "A10",
						"lon": lon,
						"lat": lat
					},
					success: function (response) {
						// 3. json에서 주소 파싱
						var arrResult = response.addressInfo;

						//법정동 마지막 문자 
						var lastLegal = arrResult.legalDong
							.charAt(arrResult.legalDong.length - 1);

						// 새주소
						newRoadAddr = arrResult.city_do + ' '
							+ arrResult.gu_gun + ' ';

						if (arrResult.eup_myun == ''
							&& (lastLegal == "읍" || lastLegal == "면")) {//읍면
							newRoadAddr += arrResult.legalDong;
						} else {
							newRoadAddr += arrResult.eup_myun;
						}
						newRoadAddr += ' ' + arrResult.roadName + ' '
							+ arrResult.buildingIndex;

						// 새주소 법정동& 건물명 체크
						if (arrResult.legalDong != ''
							&& (lastLegal != "읍" && lastLegal != "면")) {//법정동과 읍면이 같은 경우

							if (arrResult.buildingName != '') {//빌딩명 존재하는 경우
								newRoadAddr += (' (' + arrResult.legalDong
									+ ', ' + arrResult.buildingName + ') ');
							} else {
								newRoadAddr += (' (' + arrResult.legalDong + ')');
							}
						} else if (arrResult.buildingName != '') {//빌딩명만 존재하는 경우
							newRoadAddr += (' (' + arrResult.buildingName + ') ');
						}

						$('#current-location').text(newRoadAddr);
						document.querySelector('#current-location').value = newRoadAddr;
						console.log(document.querySelector('#current-location').value)
					},
					error: function (request, status, error) {
						console.log("code:" + request.status + "\n"
							+ "message:" + request.responseText + "\n"
							+ "error:" + error);
					}
				});
		}

		// 포스팅 모달 부분
		$(function () {
			//이미지 전체 감쌀곳
			const multipleContainer = document.getElementById("multiple-container");

			// 파일 업로드 된 내용이 변화
			$("#photoInput").on('change', function () {
				while (multipleContainer.firstChild) {
					multipleContainer.removeChild(multipleContainer.firstChild);
				}
				readURL(this);
			});

			function readURL(input) {
				// 인풋 태그에 파일들이 있는 경우
				if (input.files) {
					// 이미지 파일 검사 (생략)
					console.log(input.files);
					// 유사배열을 배열로 변환 (forEach문으로 처리하기 위해)
					const fileArr = Array.from(input.files);

					//파일마다 img태그만들어서 multicontainer에 넣기
					fileArr.forEach((file) => {
						// 파일 읽기
						const reader = new FileReader();
						// 이미지 태그 만들기
						const $img = document.createElement("img");

						//파일을 읽으면 - callback함수
						reader.onload = e => {
							console.log(file.name);
							$img.src = e.target.result;
							$img.arc = file.name;
							$img.style.width = "40%";
						}

						//container에 넣고, 이미지 로드
						multipleContainer.appendChild($img);
						reader.readAsDataURL(file);
					});
				}
			}
		});

		document.getElementById('time').value = new Date().toISOString().slice(0, 10);

		function openChild() {
			// window.name = "부모창 이름"; 
			window.name = "parentForm";
			// window.open("open할 window", "자식창 이름", "팝업창 옵션");
			var win = window.open("./newlocation.html", "newLocation", "width=400, height=450");
		}
		function setChildValue(name) {
			document.querySelector('#current-location').value = name;
			var text = document.querySelector('#current-location').value;
			document.querySelector('#current-location').innerHTML = text;
		}
		function setLocation(lat, lng) {
			latitude = lat;
			longtitude = lng;
		}

	</script>
</head>

<body onload="getLocation();">
	<h1>색동산</h1>

	<!-- 로그인기능 -->
	<div class="g-signin2" data-onsuccess="onSignIn"></div>
	<a href="#" onclick="signOut();">Sign out</a>

	<!-- 상단 바 -->
	<nav class="navbar navbar-expand-lg navbar-light bg-light">
		<a class="navbar-brand" href="#">Navbar</a>
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup"
			aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		<div class="collapse navbar-collapse" id="navbarNavAltMarkup">
			<div class="navbar-nav">
				<a class="nav-item nav-link active" href="#">Home <span class="sr-only">(current)</span></a>
				<a class="nav-item nav-link" href="#">카테고리</a>
				<a class="nav-item nav-link" href="#">길찾기</a>
				<a class="nav-item nav-link" href="#">추천경로</a>
			</div>
		</div>
	</nav>

	<!-- 지도 -->
	<div class="ft_area">
		<div class="ft_select_wrap">
			<div class="ft_select">
				<select id="selectLevel">
					<option value="0" selected="selected">교통최적+추천</option>
					<option value="1">교통최적+무료우선</option>
					<option value="2">교통최적+최소시간</option>
					<option value="3">교통최적+초보</option>
					<option value="4">교통최적+고속도로우선</option>
					<option value="10">최단거리+유/무료</option>
					<option value="12">이륜차도로우선</option>
					<option value="19">교통최적+어린이보호구역 회피</option>
				</select> <select id="year">
					<option value="N" selected="selected">교통정보 표출 옵션</option>
					<option value="Y">Y</option>
					<option value="N">N</option>
				</select>
				<button id="btn_select">적용하기</button>
			</div>
		</div>
		<div class="map_act_btn_wrap clear_box"></div>
		<div class="clear"></div>
	</div>

	<div id="map_wrap" class="map_wrap">
		<div id="map_div"></div>
	</div>
	<div class="map_act_btn_wrap clear_box"></div>
	<p id="result"></p>

	<!-- 리뷰추가버튼 -->
	<button type="button" id="plus" data-bs-toggle="modal" data-bs-target="#staticBackdrop1">
		<img src="./img/plus.png" alt="리뷰 추가하기" width="100px" />
	</button>

	<!-- Modal -->
	<div class="modal fade" id="staticBackdrop1" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
		aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-scrollable modal-fullscreen-sm-down">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="staticBackdropLabel">리뷰남기기</h5>
					&nbsp; <input type="button" value="새로운 위치 선택" onclick="openChild()">
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form action='/upload' method="post" enctype="multipart/form-data">
						<div id="current-location" onchange="textchange()"> 현재 위치 주소 </div><br><br>
						<label> 장소이름
							<input type="text" name="name" placeholder="여러분만의 애칭을 정해주세요!" />
						</label>
						<label> <input type='time' id='time' style="display:none"></label>
						<br>
						<br>
						<lable> 이미지 파일 업로드
							<input type="file" id="photoInput" name="photoUpload[]" multiple="multiple" />
						</lable>
						<br>
						<br>
						<label id="multiple-container">사진 뜨기</label>
						<br>
						<br>
						<lable> 감상업로드<br>
							<textarea cols="38" rows="10" name="comment"
								placeholder="여러분이 느낀 이 곳만의 공기, 분위기, 추억등을 자유롭게 글로 남겨주세요!"></textarea>
						</lable>
						<br>
						<br>
						<label> Category :
							<select id="category">
								<option value="night" selected> 야경이 좋은 </option>
								<option value="tree"> 나무가 많은 곳 </option>
								<option value="calorie"> 칼로리 소비가 많은 곳 </option>
								<option value="hip"> HIP함이 느껴지는 곳 </option>
								<option value="thrill"> 스릴 넘치는 곳 </option>
								<option value="happy"> 행복함을 주는 곳 </option>
							</select>
						</label>
						<br>
						<br>
						<button type="button" name="good" value="o">추천</button>
						<button type="button" name="bad" value="x">비추천</button>
						<br>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					<button type="submit" id="posting_submit">등록하기</button>
				</div>
				</form>
			</div>
		</div>
	</div>
</body>

</html>